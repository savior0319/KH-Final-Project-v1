<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="myInfo">
	<resultMap type="member" id="memberDB">
		<result property="mbIndex" column="MB_INDEX" />
		<result property="mbId" column="MB_ID" />
		<result property="mbPwd" column="MB_PWD" />
		<result property="mbName" column="MB_NAME" />
		<result property="mbNickName" column="MB_NICKNAME" />
		<result property="mbGender" column="MB_GENDER" />
		<result property="mbImage" column="MB_IMAGE" />
		<result property="mbPromise" column="MB_PROMISE" />
		<result property="mbAge" column="MB_AGE" />
		<result property="mbPhone" column="MB_PHONE" />
		<result property="mbAddress" column="MB_ADDRESS" />
		<result property="mbInterest" column="MB_INTEREST" />
		<result property="mbGrade" column="MB_GRADE" />
		<result property="mbHeight" column="MB_HEIGHT" />
		<result property="mbWeight" column="MB_WEIGHT" />
		<result property="mbBmi" column="MB_BMI" />
		<result property="mbReport" column="MB_REPORT" />
		<result property="mbEnrollDate" column="MB_ENROLLDATE" />
	</resultMap>

	<!-- 1대1 문의 -->
	<insert id="question" parameterType="question">
		INSERT INTO QUESTION_TBL
		VALUES(QUESTION_SEQ.NEXTVAL, #{qsTitle}, #{qsContent}, #{mbIndex},
		SYSDATE, #{qsAnswerCheck})
	</insert>

	<!-- 회원 탈퇴 -->
	<delete id="secessionMember" parameterType="member">
		DELETE FROM
		MEMBER_TBL WHERE MB_ID = #{mbId}
	</delete>

	<!-- 회원정보 수정 -->
	<update id="updateMyInfo" parameterType="member">
		UPDATE MEMBER_TBL
		SET
		MB_PWD = #{mbPwd},
		MB_NICKNAME = #{mbNickName},
		MB_PHONE = #{mbPhone},
		MB_PROMISE = #{mbPromise},
		MB_HEIGHT = #{mbHeight},
		MB_WEIGHT =
		#{mbWeight}
		WHERE MB_ID = #{mbId}
	</update>

	<!-- 한명의 회원정보 -->

	<select id="selectOneMember" parameterType="member"
		resultType="member">
		SELECT
		MB_INDEX AS mbIndex,
		MB_ID AS mbId,
		MB_REPORT AS
		mbReport,
		MB_PWD AS mbPwd,
		MB_NAME AS mbName,
		MB_NICKNAME AS mbNickName,
		MB_GENDER AS mbGender,
		MB_IMAGE AS mbImage,
		MB_PROMISE AS mbPromise,
		MB_AGE AS mbAge,
		MB_PHONE AS mbPhone,
		MB_ADDRESS AS mbAddress,
		MB_INTEREST AS mbInterest,
		MB_GRADE AS mbGrade,
		MB_HEIGHT AS mbHeight,
		MB_WEIGHT AS mbWeight,
		MB_ENROLLDATE
		AS mbEnrollDate
		FROM MEMBER_TBL
		WHERE MB_ID = #{mbId}
	</select>
	<!-- 마이페이지 - 프로필 사진 삭제 -->
	<delete id="deleteMyPicture" parameterType="member">
		UPDATE MEMBER_TBL SET
		MB_IMAGE
		='http://upload.inven.co.kr/upload/2014/11/01/bbs/i3464037277.jpg'
		WHERE MB_ID = #{mbId}
	</delete>

	<!-- 마이페이지 - 일대일 문의 -->
	<select id="allMyOneToOneQuestion" parameterType="member"
		resultType="question">
		SELECT QS_INDEX AS qsIndex, QS_TITLE AS qsTitle,QS_CONTENT
		AS qsContent,
		QS_WRITETIME AS qsWriteTime, QS_ANSWERCHECK AS
		qsAnswerCheck
		FROM
		QUESTION_TBL WHERE MB_INDEX = #{mbIndex}
	</select>


	<!-- 마이페이지 - 장바구니 -->

	<select id="myWishList" parameterType="member"
		resultType="product">
		SELECT PD_INDEX AS pdIndex,PD_NAME AS pdName ,PD_IMAGE AS
		pdImage,
		PD_PRICE AS pdPrice FROM PRODUCT_TBL
		JOIN MY_WISHLIST_TBL
		USING(PRODUCT_INDEX)
		JOIN MEMBER_TBL USING(MB_INDEX)
		WHERE MB_ID =
		#{mbId}
	</select>


	<!-- 회원 가입 -->
	<insert id="signup" parameterType="member">
		INSERT INTO MEMBER_TBL
		VALUES(MEMBER_SEQ.NEXTVAL, #{mbId}, #{mbPwd}, null, #{mbNickName},
		#{mbGender},
		'http://upload.inven.co.kr/upload/2014/11/01/bbs/i3464037277.jpg',
		null, null, null, null, #{mbInterest},
		'일반회원', null,
		null, null, 'n',
		SYSDATE)
	</insert>

	<!-- 나의 활동 정보 (출석,댓글,게시물,가입날짜) -->
	<select id="myActivity" parameterType="member"
		resultType="myActivity">
		SELECT MB_INDEX AS mbIndex,
		(SELECT COUNT(*) FROM
		ON_SESSION_TBL WHERE SS_INDEX = #{mbIndex}) AS myAttendance,
		(SELECT
		COUNT(*) FROM BOARD_COMMENT_TBL WHERE MB_INDEX = #{mbIndex}) AS
		myCommentCount,
		(SELECT COUNT(*) FROM BOARD_POST_TBL WHERE MB_INDEX =
		#{mbIndex}) AS myBoardCount,
		MY_ENROLLDATE as mbEnrollDate,
		MB_GRADE AS
		mbGrade
		FROM MY_ACTIVITY_TBL JOIN MEMBER_TBL USING(MB_INDEX) where
		mb_index =
		#{mbIndex}
	</select>

	<resultMap type="community" id="communityDB">
		<result property="postIndex" column="POST_INDEX" />
		<result property="brdIndex" column="BRD_INDEX" />
		<result property="postTitle" column="POST_TITLE" />
		<result property="postContent" column="POST_CONTENT" />
		<result property="mbIndex" column="MB_INDEX" />
		<result property="postDateTime" column="POST_DATETIME" />
		<result property="postComCount" column="POST_COMMENT_COUNT" />
		<result property="postHit" column="POST_HIT" />
		<result property="postLike" column="POST_LIKE" />
		<result property="postImage" column="POST_IMAGE" />
		<result property="bcaIndex" column="BCA_INDEX" />
	</resultMap>

	<!-- 마이페이지 나의게시물 내비게이션 생성 -->
	<select id="myPostGetNavi" resultType="java.lang.Integer"
		parameterType="myActivity">
		SELECT COUNT(*) AS totalCount
		FROM BOARD_POST_TBL WHERE
		MB_INDEX = #{mbIndex}
	</select>


	<select id="myPostList" parameterType="myPostPDVO"
		resultType="community" resultMap="communityDB">
		SELECT *
		FROM (SELECT
		BOARD_POST_TBL.*,
		ROW_NUMBER() OVER(ORDER BY
		POST_DATETIME
		DESC) AS NUM
		FROM
		BOARD_POST_TBL WHERE MB_INDEX = #{mbIndex}
		) WHERE NUM BETWEEN
		#{start} AND #{end}
	</select>

	<select id="myBookMarkGetList">
		SELECT *
		FROM (SELECT
		BOARD_BOOKMARK_TBL.*,
		ROW_NUMBER() OVER(ORDER BY
		DESC) AS NUM
		FROM
		BOARD_BOOKMARK_TBL
		) WHERE
		NUM BETWEEN #{start} AND #{end}
	</select>

	<select id="nickNameCheck" parameterType="member"
		resultType="member">
		SELECT
		MB_INDEX AS mbIndex,
		MB_ID AS mbId,
		MB_PWD AS mbPwd,
		MB_NAME AS
		mbName,
		MB_NICKNAME AS mbNickName,
		MB_GENDER AS mbGender,
		MB_IMAGE
		AS
		mbImage,
		MB_PROMISE AS mbPromise,
		MB_AGE AS mbAge,
		MB_PHONE AS
		mbPhone,
		MB_ADDRESS AS mbAddress,
		MB_INTEREST AS mbInterest,
		MB_GRADE AS
		mbGrade,
		MB_HEIGHT AS mbHeight,
		MB_WEIGHT AS mbWeight,
		MB_BMI AS
		mbBmi,
		MB_REPORT AS mbReport,
		MB_ENROLLDATE AS mbEnrollDate
		FROM MEMBER_TBL
		WHERE MB_NICKNAME = #{nickName}
	</select>

	<!-- 마이페이지 - 프로필 사진 업데이트 -->
	<update id="updateMyPicture" parameterType="member">
		UPDATE MEMBER_TBL SET
		MB_IMAGE = #{mbImage} where MB_ID = #{mbId}
	</update>

	<!-- 마이페이지 - 나의 게시물 -->
	<select id="myPost" resultType="community"
		resultMap="communityDB" parameterType="member">
		SELECT
		POST_TITLE AS postTitle,
		POST_CONTENT AS postContent,
		POST_DATETIME AS postDateTime,
		POST_INDEX
		AS postIndex
		FROM BOARD_POST_TBL WHERE MB_INDEX = #{mbIndex}
	</select>

	<!-- 마이페이지 - 나의 댓글 -->
	<select id="myCommentList" resultType="comment"
		parameterType="member">

		SELECT BOARD_POST_TBL.POST_INDEX AS postIndex,
		BOARD_POST_TBL.POST_TITLE AS postTitle,CMT_CONTENT AS cmtContent,
		CMT_DATETIME AS cmtDateTime FROM BOARD_POST_TBL
		RIGHT JOIN
		BOARD_COMMENT_TBL
		ON (BOARD_POST_TBL.POST_INDEX =
		BOARD_COMMENT_TBL.POST_INDEX)
		WHERE
		BOARD_COMMENT_TBL.MB_INDEX =
		(SELECT
		DISTINCT MB_INDEX FROM
		BOARD_COMMENT_TBL WHERE MB_INDEX = #{mbIndex})


	</select>

	<!-- 나의 댓글 페이징 처리 - 내비게이션 생성 -->

	<select id="myCommentGetNavi" resultType="java.lang.Integer"
		parameterType="myActivity">
		SELECT COUNT(*) AS totalCount
		FROM BOARD_COMMENT_TBL
		WHERE MB_INDEX = #{mbIndex}

	</select>


	<!-- 마이페이지 - 나의 북마크 -->
	<select id="myBookMark" resultType="bookMark"
		parameterType="bookMark">

		SELECT POST_HIT AS postHit,MB_INDEX,POST_TITLE,POST_HIT,
		POST_DATETIME AS postDateTime
		FROM BOARD_BOOKMARK_TBL LEFT JOIN
		BOARD_POST_TBL USING(MB_INDEX) WHERE MB_INDEX = #{mbIndex}
	</select>

	<!-- 마이페이지 - 일대일 문의 관리자 답변 -->
	<select id="questionAnswer" resultType="question"
		parameterType="Integer">
		SELECT
		QS_INDEX AS qsIndex,
		QS_TITLE AS qsTitle,
		QS_CONTENT AS qsContent,
		MB_NICKNAME AS mbNickName,
		QS_WRITETIME AS
		qsWriteTime,
		QS_ANSWERCHECK AS qsAnswerCheck,
		ANS_CONTENT AS ansContent
		FROM MEMBER_TBL JOIN QUESTION_TBL USING (MB_INDEX)
		LEFT OUTER JOIN
		ANSWER_TBL USING(QS_INDEX) WHERE QS_INDEX = #{qsIndex}
	</select>
</mapper>

